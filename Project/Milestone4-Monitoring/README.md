# M4 Monitoring
In this Milestone, we added monitoring agents for our infrastructure and did some FlameGraph analysis

### Team Members
1. Webb Chawla
2. Ananthram Eklaspuram
3. Bhavya Bansal
4. Kushagra Mishra

## Presentation
[Watch Here](https://youtu.be/g7LHR9WnEOo)

## Flame Graphs for CheckBox.io

### To generate Flame Graphs

We have created a test.js file which will make requests to our "end points" we need to test. Thought process is to run two parallel commands, first is "node test.js <end point>" and second is "./record.sh" which will record the stack traces. For this, we have created a shell script "parallel_commands.sh" which will run two commands above in parallel. Once we have the "perf.data" file, we can run: "generateGraph.sh <endPointName>" to generate the flame graph for the given end point.

 A sample run to generate the flamegraph for endpoint: /api/toggleFeature is:

 1. Run command: ./parallel_commands.sh "node test.js /api/toggleFeature" "./record.sh"

 2. Run command: ./generategraph.sh endPoint1

 This will generate the flamegraph for the endpoint listed above and the file will be saved as "endPoint1.svg"


### Flame Graphs


```
X axis - Number of samples for that function/call
Y axis - Stack call depth
Peak - Current function CPU during sampling
Width of a box - represents how frequent the function is ran
```
Click any of the following the view the flamegraph svgs...

![ /api/StudyListing Endpoint](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/s1_study_listing.svg "Study Listing Endpoint")

![ /api/toggleFeature Endpoint](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/s2_toggleFeature.svg "Toggle Feature Endpoint")

![ /api/vote/status Endpoint](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/s3_vote_status.svg "Vote Status Endpoint")

![ /api/admin/notify Endpoint](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/s4_admin_notify.svg "Admin Notify Endpoint")


These Flame graphs were generated by making 10 calls to each of the API endpoints

### Flame Graph Analysis

1. We see that most of the API calls are short (represented by the peaks in the graph), the CPU is mostly occupied by System functions like the MSR driver access etc.
2. The functions of checkbox.io which run for the longest are proto.js, querry.js, connect.js, bodyParser.js all from the Express module
3. Additionally, when viewing the flame graphs, we noticed the first request always spiked up very high, while the subsequent ones were not as high. We believe this is because the initial request returns a status of 200, while the following are 304 Not Modified, so it uses less cpu to return the cached version.



#### Reference:

 - http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html
 - http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html



## New Relic Infrastructure Monitoring for iTrust

We set up dashboard to monitor our iTrust infrastructure in real-time and create alerts incase of any events, using New Relic service.

We install New Relic agents in our servers during deployment, to implement this we have created a role called [Monitoring](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/Deployment/Monitoring) in our [Deployment scripts.](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/Deployment)

### Update the NewRelic License key in the template files in Monitoring role before proceeding
```
license_key: <Your license key here>
display_name: Database_{{ ansible_hostname }}
```
### To Run

Use the following command to run playbook to set up Build Servers:

  ansible-playbook install_jenkins.yml -u <Default user of your EC2 Ubuntu instance> --private-key=<Your EC2 Private Key> -i inventory.ini --ask-become-pass

### Screenshots
Basic Bashboard with all hosts
![Hosts](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/NewRelic%20Images/hosts.png "Hosts")
Network Resources Dashboard
![Network Resources](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/network.png "Network Resources")
Storage Resources
![Storage Resources](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/NewRelic%20Images/storage.png "Storage Resources")

We have a CPU alert that goes up when CPU usage on any server goes above 20% for continuous 2 minutes
![Alerts](https://github.com/Ananthram/Devops_NCSU/blob/master/Project/Milestone4-Monitoring/NewRelic%20Images/alert.png "alert.png")
